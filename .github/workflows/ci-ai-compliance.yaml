name: AI Compliance Scan

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master]

permissions:
  contents: read
  actions: read

concurrency:
  group: "scan-gen-code-compliance"
  cancel-in-progress: true

jobs:
  compliance:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Historia completa para scans

      # Licencias/Copyrights con ScanCode (rule-based, snippets)
      # Nota: Escanea directorios especÃ­ficos para evitar conflictos con directorios temporales
      - name: ScanCode License Scan
        uses: aboutcode-org/scancode-action@beta
        with:
          pipelines: "scan_codebase"
          output-formats: "json"
          check-compliance: true
          compliance-fail-level: "ERROR"
          inputs-path: "workflow-failure-analyzer .github LICENSE"
        continue-on-error: false

      # ORT: Compliance full (licencias, vulns, polÃ­ticas)
      # Nota: ORT-CI corre anÃ¡lisis completo sin configuraciÃ³n adicional
      - name: OSS Review Toolkit (ORT)
        uses: oss-review-toolkit/ort-ci-github-action@v1
        continue-on-error: false

      # Secrets scan con TruffleHog
      - name: TruffleHog Secrets Scan
        uses: trufflesecurity/trufflehog@v3.63.5
        with:
          path: ./
          extra_args: --only-verified
        continue-on-error: false

      # Upload reports para revisiÃ³n
      - name: Upload Compliance Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: compliance-reports-${{ github.run_number }}
          path: |
            **/*scancode*.json
            **/*ort*.json
            **/ort-results/
            ort-result/
            scancode-results/
            .ort/
          retention-days: 30
          if-no-files-found: warn

      # Report to GitHub Actions Summary
      - name: Generate Compliance Summary
        if: always()
        run: |
          echo "## ðŸ¤– AI Compliance Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date**: $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_STEP_SUMMARY
          echo "**Event**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Scans Executed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ScanCode (Licenses & Copyright)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… OSS Review Toolkit (ORT)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… TruffleHog (Secrets Detection)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.event_name }}" = "push" ] && [ "${{ github.ref }}" = "refs/heads/main" ]; then
            echo "â„¹ï¸ AI Disclosure will be updated by dedicated workflow" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "See artifacts for detailed reports." >> $GITHUB_STEP_SUMMARY
        shell: bash
