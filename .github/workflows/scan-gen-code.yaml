name: Máxima Garantía Compliance Scan

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master]

jobs:
  compliance:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Historia completa para scans

      # Licencias/Copyrights con ScanCode (rule-based, snippets)
      # Nota: Escanea directorios específicos para evitar conflictos con directorios temporales
      - name: ScanCode License Scan
        uses: aboutcode-org/scancode-action@beta
        with:
          pipelines: "scan_codebase"
          output-formats: "json"
          check-compliance: true
          compliance-fail-level: "ERROR"
          inputs-path: "workflow-failure-analyzer .github LICENSE"
        continue-on-error: false

      # ORT: Compliance full (licencias, vulns, políticas)
      # Nota: ORT-CI corre análisis completo sin configuración adicional
      - name: OSS Review Toolkit (ORT)
        uses: oss-review-toolkit/ort-ci-github-action@v1
        continue-on-error: false

      # Secrets scan con TruffleHog
      # Custom config: .trufflehog-config.json (opcional)
      - name: TruffleHog Secrets Scan
        uses: trufflesecurity/trufflehog@v3.63.5
        with:
          path: ./
          extra_args: --only-verified --entropy --config .trufflehog-config.json
        continue-on-error: false

      # Upload reports para revisión
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: compliance-reports
          path: |
            scancode-outputs/
            ort-result/
            trufflehog-report.json
            semgrep.sarif

      # Step AI Disclosure (EU AI Act compliance)
      - name: AI Content Disclosure
        run: |
          echo 'AI-generated or assisted code detected. Review logs.' > AI_DISCLOSURE.md
          echo "Timestamp: $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> AI_DISCLOSURE.md
          echo "Compliance: EU AI Act Art.50" >> AI_DISCLOSURE.md
          echo "" >> AI_DISCLOSURE.md
          echo "## AI-Assisted Files" >> AI_DISCLOSURE.md
          # Añade metadata (C2PA-like) a archivos clave
          for file in $(git ls-files '*.py' '*.js' '*.yaml' '*.yml'); do
            echo "- $file" >> AI_DISCLOSURE.md
            echo "# AI-assisted file (EU AI Act Art.50) - Generated: $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> "$file".ai-meta
          done
        shell: bash

      - name: Commit Disclosure if needed
        if: github.event_name == 'push'
        run: |
          git config user.name "Compliance Bot"
          git config user.email "bot@github.com"
          git add . || true
          git commit -m "EU AI Act: Add disclosure metadata [skip ci]" || echo "No changes to commit"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
