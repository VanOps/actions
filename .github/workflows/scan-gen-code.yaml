name: Máxima Garantía Compliance Scan

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master]

jobs:
  compliance:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Historia completa para scans

      # Licencias/Copyrights con ScanCode (rule-based, snippets)
      - name: ScanCode License Scan
        uses: aboutcode-org/scancode-action@beta
        with:
          pipelines: "scan_codebase"
          output-formats: "json,spdx,cyclonedx"
          check-compliance: true
          compliance-fail-level: "ERROR"
          inputs-path: "."
        continue-on-error: false

      # Doble check con FOSSology (Nomos/Ojo para copyrights)
      - name: FOSSology Scan
        uses: fossology/fossology-action@v1 # O GMishx/fossology-scan@v1 si no disponible
        with:
          scan-mode: "new" # 'diff' para PRs
          scanners: "nomos,ojo,ninka"
          upload-token: ${{ secrets.FOSSOLOGY_UPLOAD_TOKEN }} # Opcional para server propio
        continue-on-error: false

      # ORT: Compliance full (licencias, vulns, políticas)
      - name: OSS Review Toolkit (ORT)
        uses: oss-review-toolkit/ort-ci-github-action@v1
        with:
          config: |
            ort: {
              licenseClassifications: {
                allowed: [ "${{ vars.ALLOWED_LICENSES }}" ]  # MIT,Apache-2.0,etc.
              }
            }
          analyzer: {}
          scanner: {}
        continue-on-error: false

      # Secrets scan con TruffleHog
      - name: TruffleHog Secrets Scan
        uses: trufflesecurity/trufflehog@main
        with:
          extra_args: --fail --only-verified --entropy --config .trufflehog-config.json # Custom config si necesitas
        continue-on-error: false

      # SAST con Semgrep (vulnerabilidades código)
      - name: Semgrep SAST
        uses: semgrep/semgrep-action@v2
        with:
          config: >-
            p/python
            p/secrets
            p/r2c-ci
          publishToken: ${{ secrets.SEMGREP_APP_TOKEN }} # Gratuito en semgrep.dev
          generateSarif: true
        continue-on-error: false

      # Upload reports para revisión
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: compliance-reports
          path: |
            scancode-outputs/
            fossology-results/
            ort-result/
            trufflehog-report.json
            semgrep.sarif

      # Step AI Disclosure (EU AI Act compliance)
      - name: AI Content Disclosure
        run: |
          echo 'AI-generated or assisted code detected. Review logs.' > AI_DISCLOSURE.md
          # Añade metadata (C2PA-like) a archivos clave
          for file in $(git ls-files '*.py' '*.js' '*.yaml'); do
            echo "# AI-assisted file (EU AI Act Art.50)" >> "$file".ai-meta
            echo "Generated: $(date)" >> "$file".ai-meta
          done
        shell: bash

      - name: Commit Disclosure if needed
        if: github.event_name == 'pull_request'
        run: |
          git config user.name "Compliance Bot"
          git config user.email "bot@github.com"
          git add *.ai-meta AI_DISCLOSURE.md
          git commit -m "EU AI Act: Add disclosure metadata [skip ci]" || echo "No changes"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
