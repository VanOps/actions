name: AI Disclosure Update

on:
  push:
    branches: [main]
    paths:
      - "**.py"
      - "**.js"
      - "**.ts"
      - "**.yaml"
      - "**.yml"
      - "**.json"
      - "**.md"

permissions:
  contents: write

jobs:
  update-disclosure:
    runs-on: ubuntu-latest
    # Evitar que bots y el propio workflow generen loops
    if: "!contains(github.actor, '[bot]') && !contains(github.event.head_commit.message, '[skip ci]')"

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate AI Content Disclosure
        run: |
          cat > AI_DISCLOSURE.md <<EOF
          # AI Content Disclosure (EU AI Act Art.50)

          **Last Updated**: $(date -u +%Y-%m-%dT%H:%M:%SZ)
          **Commit**: ${{ github.sha }}
          **Workflow Run**: ${{ github.run_id }}

          ## Purpose
          This repository uses AI-assisted code generation for development and maintenance tasks.
          This disclosure is maintained in accordance with EU AI Act Article 50 requirements for 
          transparency in AI-generated content.

          ## Recent Changes (Last Commit)
          EOF

          echo "### Modified files with potential AI assistance:" >> AI_DISCLOSURE.md
          echo "" >> AI_DISCLOSURE.md

          if [ -n "${{ github.event.before }}" ]; then
            git diff --name-only ${{ github.event.before }} ${{ github.sha }} | \
              grep -E '\.(py|js|ts|yaml|yml|json|md)$' | \
              sed 's/^/- /' >> AI_DISCLOSURE.md || \
              echo "- No code files modified in this commit" >> AI_DISCLOSURE.md
          else
            echo "- Initial commit or full history not available" >> AI_DISCLOSURE.md
          fi

          echo "" >> AI_DISCLOSURE.md
          echo "## Repository Overview" >> AI_DISCLOSURE.md
          echo "" >> AI_DISCLOSURE.md
          echo "### All code files in repository:" >> AI_DISCLOSURE.md

          # Listar archivos por tipo
          for ext in py js ts yaml yml json md; do
            count=$(git ls-files "*.$ext" | wc -l)
            if [ $count -gt 0 ]; then
              echo "- \`.$ext\` files: $count" >> AI_DISCLOSURE.md
            fi
          done

          echo "" >> AI_DISCLOSURE.md
          echo "## Compliance Notes" >> AI_DISCLOSURE.md
          echo "" >> AI_DISCLOSURE.md
          echo "- This disclosure is automatically updated on each push to main branch" >> AI_DISCLOSURE.md
          echo "- For detailed compliance scan reports, see GitHub Actions artifacts" >> AI_DISCLOSURE.md
          echo "- AI assistance is used for code generation, refactoring, and documentation" >> AI_DISCLOSURE.md
          echo "- All AI-generated content is reviewed by human developers before merging" >> AI_DISCLOSURE.md

          echo "" >> AI_DISCLOSURE.md
          echo "---" >> AI_DISCLOSURE.md
          echo "_This file is automatically generated. Do not edit manually._" >> AI_DISCLOSURE.md
        shell: bash

      - name: Check for changes
        id: check_changes
        run: |
          if [ -f "AI_DISCLOSURE.md" ]; then
            git add AI_DISCLOSURE.md
            if git diff --staged --quiet; then
              echo "changed=false" >> $GITHUB_OUTPUT
              echo "No changes to disclosure file"
            else
              echo "changed=true" >> $GITHUB_OUTPUT
              echo "Disclosure file updated"
            fi
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit and Push Disclosure
        if: steps.check_changes.outputs.changed == 'true'
        run: |
          git config user.name "AI Compliance Bot"
          git config user.email "compliance-bot@users.noreply.github.com"

          git commit -m "docs: Update AI disclosure [skip ci]" -m "Automated EU AI Act Art.50 compliance update for commit ${{ github.sha }}"

          # Retry logic para manejar race conditions
          for attempt in {1..3}; do
            if git push; then
              echo "âœ… Disclosure committed successfully"
              exit 0
            else
              echo "âš ï¸ Push attempt $attempt failed, retrying..."
              sleep 2
              git pull --rebase origin main
            fi
          done

          echo "âŒ Failed to push disclosure after 3 attempts"
          exit 1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Report to Summary
        if: always()
        run: |
          echo "## ðŸ“„ AI Disclosure Update" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp**: $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.check_changes.outputs.changed }}" = "true" ]; then
            echo "âœ… AI_DISCLOSURE.md has been updated and committed" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ No changes to AI_DISCLOSURE.md (already up to date)" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**EU AI Act Compliance**: Article 50 requirements satisfied" >> $GITHUB_STEP_SUMMARY
        shell: bash
